---
title: "Spatial aggregation of Relative Severity values"
output: html_document
editor_options: 
  chunk_output_type: console
---

So far we have looked at relative severity of single units of observation (raster cells or glacier outlines) but we are interested in describing degradation of abiotic conditions in the whole assessment unit.

```{r}
#| eval: true
#| echo: false
#| message: false
library(dplyr)
library(ggplot2)
library(readr)
library(ggforce)
library(DT)
library(htmltools)
library(purrr)
library(ggpubr)
library(stringr)
here::i_am("docs-src/RS/spatial-variability.qmd")
# sessionInfo()
# Suppress summarise info
options(dplyr.summarise.inform = FALSE)
```

```{r}
#| eval: true
#| message: false
target.dir <- "sandbox"
results_file <- here::here(target.dir, "relative-severity-degradation-suitability-all-tropical-glaciers.csv")
RS_results <- read_csv(results_file, show_col_types = FALSE) %>% 
  mutate(unit_name=str_replace_all(unit,"-"," "))
results_file <- here::here(target.dir, "massbalance-model-data-all-groups.rds")
massbalance_results <- readRDS(results_file)
source(here::here("inc","R","RS-functions.R"))
```

```{r}

old <- theme_set(theme_linedraw())
theme_update(panel.grid.minor = element_line(colour = "pink"),
panel.grid.major = element_line(colour = "rosybrown3"))

```

## Considerations before aggregation

Our two indicator variable differ fundamentally in units and interpretation and we have to consider this when we aggregate the values of RS calculated from the sampling or observation units to larger assessment units. We also have to consider the choice of formula to calculate RS and the interpretation of the collapse threshold in each case.

### Sampling units

For our two indicator variables we have different sample sizes per assessment unit. In the case of the dynamic ice mass balance model the units of observation are glacier outlines from the Randolph Glacier Inventory, while in the bioclimatic suitability model the units of observation are cell in a spatial grid that overlap with glacier outlines from multiple sources. 

```{r}

massbalance_results %>% 
  group_by(unit_name) %>% 
  summarise(`Sampling size (ice)` = n_distinct(RGIId)) %>%
  full_join({
    RS_results %>% 
    group_by(unit_name) %>% 
    summarise(`Sampling size (bcs)` = n_distinct(id,cellnr))
    },
    by=c("unit_name")
  )  %>% 
  datatable(
    options = list(
        dom = 't', 
        pagination = FALSE, 
        pageLength = -1
        )
    ) 

```

Differences in sample size are noticeable in one assessment units that covers areas of Peru and Chile.  The national glacier inventory of Chile include more detail about different ice accumulations types, including rock glaciers, that are not represented in the global inventories.



### Interpretation of values and collapse thresholds

The indicator variable of ice mass is a positive variable and represents a physical measurement of mass. For this variable the  collapse threshold of $0 kg$ indicates complete loss of the icy substrate. 

For the indicator variable of bioclimatic suitability we are using a probability estimated by the model that requires additional interpretation. We use a confusion matrix to calculate predictive performance of the model and decide the best cut-off value between suitable and unsuitable habitat, and use that cut-off value as an estimate of collapse threshold indicating a shift in suitability conditions.

## RS for the loss of ice mass



## RS for decline in bioclimatic suitability

In the case of the bioclimatic suitability model we are using spatial units with the same area and the index of suitability is not a direct measure of physical properties of the ecosystem. 

We can use the simple mean of the individual RS values per cell to summarise relative severity per assessment unit. But there are other complementary summary statistics to represent the spatial variability in values of RS in an assessment unit. 

For small assessment units the spatial sample size for the calculation of RS is small and values tend to be relatively similar. Differences can be visualised conveniently with boxplots. 

```{r}
#| label: fig-ruwenzori
#| fig-cap: "Box and whisker plots of the $RS_{bcs}^{acc}$ values for the Tropical Glacier Ecosystem of Ruwenzori. The middle line represent the location of the median and the box include the distribution from first to third quartile, the location of the mean is marked with an X symbol."
dat1 <- RS_results %>% 
  filter(
    unit %in% "Ruwenzori", 
    threshold == "acc",
    pathway == "ssp370",
    modelname == "mri-esm2-0")
dat2 <- dat1 %>% 
  group_by(timeframe,pathway,modelname) %>% 
  summarise(mean_RS=mean(RS_cor))

ggplot(dat1 ) +
  geom_boxplot(aes(y = RS_cor, x = timeframe, colour = timeframe)) +
  geom_point(data=dat2, aes(y = mean_RS, x = timeframe, colour = timeframe),pch=4,cex=2) +
  facet_grid(pathway~modelname) +
  theme(legend.position = "none") +
  xlab("Future period")
```

For larger sampling units we can see more complex distributions of RS values. In the case of the Cordilleras Norte de Peru we have more than thousand raster cells with values of relative severity. Histograms of the relative severity values show a wide spread of value in one selected future period, with most cell in the 75 - 100 % interval, but still many cell in the lowest quartile. This is reflected in the difference between mean and median RS values.


```{r}
#| label: fig-hist-ecuador
#| fig-cap: Histogram of the $RS_{cor}$ values for the Tropical Glacier Ecosystem of the Cordilleras Norte de Peru using the maximum accuracy threshold.
#| warning: false
dat1 <- RS_results %>% 
  filter(threshold=="acc", 
         unit_name == "Cordilleras Norte de Peru", 
         modelname == "mri-esm2-0",
         pathway == "ssp126",
         timeframe == "2041-2070")
dat2 <- dat1 %>% group_by(timeframe) %>% 
  summarise(
    n=n(),
    mean_RS=mean(RS_cor,na.rm=T),
    median_RS=median(RS_cor,na.rm=T))

plot_a <- 
  ggplot(dat1) +
    geom_histogram(aes(x=RS_cor*100)) +
    #scale_fill_brewer(palette = "Oranges",type="seq", direction=-1) +
    #    scale_fill_manual(values = IUCN_cat_colours) +
    #geom_point(data=dat2,aes(x=mean_RS*100, y=15)) +
    geom_label(data=dat2,aes(x=mean_RS*100, y=100, label=sprintf("mean %0.3f", mean_RS))) +
    geom_label(data=dat2,aes(x=median_RS*100, y=150, label=sprintf("median %0.3f", median_RS))) +
    theme(legend.position = "none") +
    xlab("Relative severity") +
    ylab("Nr. of cells") 
plot_a 
```
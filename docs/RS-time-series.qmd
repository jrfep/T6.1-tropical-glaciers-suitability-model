---
title: "Temporal change in Relative Severity"
output: html_document
editor_options: 
  chunk_output_type: console
---


We calculate temporal change in Relative Severity by applying the RS formula to one fixed initial value and a sequence of final values, the final values can represent the state of the indicator in consecutive years (time series), or in different periods (temporal sequence). 

```{r}
#| label: load libraries and functions
#| eval: true
#| echo: false
#| message: false
library(dplyr)
library(ggplot2)
library(units)
library(stringr)
library(ggrepel)
library(purrr)
library(readr)
library(tidyr)
here::i_am("docs/RS-time-series.qmd")
source(here::here("inc","R","RS-functions.R"))
```

```{r}
#| label: read input data 
#| eval: true
#| message: false
target.dir <- "sandbox"
rds.file <- here::here(target.dir,"massbalance-totalmass-all-groups.rds")
totalmass_year_data <- readRDS(rds.file)
results_file <- here::here(target.dir, "relative-severity-degradation-suitability-all-tropical-glaciers.csv")
RS_results <- read_csv(results_file, show_col_types = FALSE) %>%
  mutate(unit_name=str_replace_all(unit," ","-"))
```

```{r}
#| label: ggplot theme
old <- theme_set(theme_linedraw())
theme_update(panel.grid.minor = element_line(colour = "pink"),
panel.grid.major = element_line(colour = "rosybrown3"))
```

## Loss of ice mass

The data from the Dynamic Ice Mass Balance model is provided in one year intervals, and we have summarise the data to provide the total value of ice mass of each assessment unit for each year.

We calculate RS using the predicted ice mass of the year 2000 as initial value, and data from subsequent years (2001 to 2100) as final values, and a collapse threshold of $0 kg$. We denote this estimate of relative severity as $RS_{ice}^{CT=0}$. Given that the collapse threshold is also the minimum value of ice possible, and that increases in ice mass are low in magnitude and limited to the start of the time series, we can use the original RS formula.

```{r}
#| label: fig-RS-timeseries
#| fig-cap: "Time series of relative severity (RS) of decline in total ice mass for different assessment units (columns) and three future scenarios (rows) based on a collapse threshold of $0 kg$ of ice. The points represents values calculated for 12 different global circulation models."
#| 
# alternative with purrr:
#RSvals <- totalmass_year_data %>% 
#  filter(unit_name %in% "Cordillera de Merida") %>%
#  group_by(model_nr,scn) %>% 
#  group_split() %>%
#  map(~RSts(.x$year,.x$total_mass)) %>% 
#  bind_rows()

RSvals <- totalmass_year_data %>% 
  filter(unit_name %in% c("Cordilleras de Colombia",
                          "Kilimanjaro", 
                          "Cordilleras Norte de Peru" ,
                          "Ecuador")) %>%
#  filter(unit_name %in% c("Ecuador")) %>%
  group_by(unit_name,model_nr,scn) %>% 
  group_modify(~RSts(
    .x$year,
    .x$total_mass,
    vmin=.x$min_mass,
    vmax=.x$max_mass,
    formula = "conditional"
    )
    ) 

ggplot(RSvals) +
  ## geom error bar is small compared to intermodel variability, keep out of the plot
  #  geom_errorbar(aes(x=year,ymin=RS_min,ymax=RS_max),alpha=.25) +
  geom_point(aes(x=year,y=RS,colour=scn),alpha=.50,cex=.5) +
  facet_grid(scn~unit_name) +
  theme(legend.position = "none")

```

## Degradation of bioclimatic suitability

Prediction of the bioclimatic suitability model are available for four consecutive periods of 30 years each. The current conditions are summarised as mean values of the bioclimatic variables for the period 1980 to 2010, and the future conditions are calculated as mean values for the periods of 2011-2040, 2041-2070 and 2071-2100. 

We calculate RS using the predicted suitability for the current conditions as initial value, and data from subsequent periods as final values. We explore different collapse thresholds based on the confusion matrix of the predictions under current conditions and the observed or known distribution of glacier outlines.  We denote this estimate of relative severity as $RS_{bcs}^{CT=acc}$, when the collapse threshold is calculated as the maximum accuracy threshold of the confusion matrix, and $RS_{bcs}^{CT=ess}$, when the collapse threshold is calculated as the threshold of equal sensitivity and specificity of the confusion matrix.[We also explored a third threshold (Positive predictive value, $ppv$), but this often resulted in high threshold values and extremely high RS values (@fig-RS-periods).]{.aside} Given that both initial and final values of suitability can be below these thresholds, and that future suitability predictions can be well above current values, we use the conditional RS formula for these estimates of RS.


```{r}
#| label: fig-RS-periods
#| fig-cap: "Mean relative severity (RS) of decline in bioclimatic suitability for the assessment unit of the T.G.E. of Ecuador for five global circulation models (points), and three different timeframes (columns), future scenarios (rows) and collapse thresholds (x axis) based on threshold of the confusion matrix ( $acc$: maximum accuracy, $ess$: equal sensitivity and specificity, and $ppv$: Positive predictive value)."
#| warning: false
slc_unit <- "Ecuador"
dat1 <- RS_results %>% 
  filter(unit %in% slc_unit) %>% 
  mutate(year=case_when(
    timeframe %in% "2011-2040"~2025,
    timeframe %in% "2041-2070"~2055,
    timeframe %in% "2071-2100"~2085
    ),
    scn=str_replace(pathway,"[ssp]+([0-9])([0-9])([0-9])","SSP\\1-\\2.\\3"),) %>%
  group_by(scn,threshold,timeframe,year,modelname) %>%
  summarise(n=n(),RSmean=mean(RS_cor),RSmed=median(RS_cor),
  .groups="keep")

ggplot(dat1) +
  geom_point(data=dat1,
               aes(y = RSmean, 
                   colour=threshold, 
                   x=threshold)) + 
  facet_grid(scn~timeframe) +
  ylab("Mean RS") +
  xlab("Collapse thresholds") +
  theme(legend.position="none")
```

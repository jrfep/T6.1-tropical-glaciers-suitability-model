---
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r}
#| eval: true
#| echo: false
#| message: false
library(dplyr)
library(ggplot2)
library(units)
library(stringr)
library(ggrepel)
library(purrr)
library(readr)
here::i_am("docs/Mass-balance-model.qmd")
# sessionInfo()

```

```{r}
#| eval: true
#| message: false
target.dir <- "sandbox"
results_file <- here::here(target.dir, "massbalance-model-data-all-groups.rds")
massbalance_results <- readRDS(results_file)
results_file <- here::here(target.dir, "relative-severity-degradation-suitability-all-tropical-glaciers.csv")
RS_results <- read_csv(results_file, show_col_types = FALSE)
source(here::here("inc","R","RS-functions.R"))
```



```{r}

old <- theme_set(theme_linedraw())
theme_update(panel.grid.minor = element_line(colour = "pink"),
panel.grid.major = element_line(colour = "rosybrown3"))

```

```{r}
year_of_collapse_data <- massbalance_results %>% 
    mutate(
      ssp=str_replace(scn,"[ssp]+([0-9])([0-9])([0-9])","SSP\\1-\\2.\\3"),
      non_collapsed=if_else(mass>0,year,2000),
           max_non_collapsed=if_else(mass+mad>0,year,2000),
           min_non_collapsed=if_else(mass-mad>0,year,2000)) %>% 
    group_by(unit_name,ssp,model_nr) %>% 
    summarise(collapse_year=max(non_collapsed,na.rm=T)+1,
              max_collapse_year=max(max_non_collapsed,na.rm=T)+1,
              min_collapse_year=max(min_non_collapsed,na.rm=T)+1,)

totalmass_year_data <- {
  massbalance_results %>% 
    mutate(scn=str_replace(scn,"[ssp]+([0-9])([0-9])([0-9])","SSP\\1-\\2.\\3"),
           mass=set_units(mass,'kg') %>% 
             set_units("Mt"),
           mad=set_units(mad,'kg') %>% 
             set_units("Mt")) %>% 
    drop_units() %>% 
    group_by(unit_name,year,scn,model_nr) %>% 
    summarise(mean_mass=sum(mass,na.rm=T),
              max_mass=sum(mass+mad,na.rm=T),
              min_mass=sum(mass-mad,na.rm=T))
  }
```


We use ice mass balance projections for the glacier of the Cordillera de Mérida based on a glacier evolution model [@Rounce_2023_MassBalance_Global]. This hybrid model combines a mass balance module and a glacier dynamics module to model glaciers independently from 2000-2100 for various ensembles of Global Circulation Models and scenarios. 

According to the published methods [@Rounce_2023_MassBalance_Global]:

> The model computes the climatic mass balance (i.e., snow accumulation minus melt plus refreezing) for each surface elevation bin using a monthly time step. The model computes glacier melt using a degree-day model, accumulation using a temperature threshold, and refreezing based on the annual air temperature. Glacier geometry is updated annually using a flowline model based on the Shallow-Ice Approximation to explicitly account for glacier dynamics using a density of 900 kg m-3 for converting mass to volume. 

The values used here are the output values (ice mass \pm median absolute deviation) of the model for the four glacier outlines of the Randolph Glacier Inventory for the cordillera de Mérida downloaded from @Rounce_2022_MassBalance_Global_Data and presented in @fig-Ea. These values clearly overestimate the existing ice mass but we focus the analysis on the point of collapse and not on the mass value _per se_.


```{r}
RSts <- function(years, values, init_year = 2000, collapse_threshold=0,vmin,vmax) {
  IV <- values[years==init_year]
  FV <- values[years>init_year]
  CT <- collapse_threshold
  OD <- IV -FV
  MD <- IV - CT
  RS <- OD/MD
  res <- tibble(year=years[years>init_year],IV,FV,CT,OD,MD,RS)
  if (!missing(vmin)) {
    IV <- vmin[years==init_year]
    FV <- vmin[years>init_year]
    OD <- IV -FV
    MD <- IV - CT
    RS <- OD/MD
    res <- res %>% bind_cols(tibble(IV_min=IV,FV_min=FV,OD_min=OD,MD_min=MD,RS_min=RS))
  }
  if (!missing(vmax)) {
    IV <- vmax[years==init_year]
    FV <- vmax[years>init_year]
    OD <- IV -FV
    MD <- IV - CT
    RS <- OD/MD
    res <- res %>% bind_cols(tibble(IV_max=IV,FV_max=FV,OD_max=OD,MD_max=MD,RS_max=RS))
  }
  return(res)
}
```


Now we can calculate the relative severity per year estimated from the mass balance model and compare this value with the relative severity estimated from the suitability model.

```{r}

#RSvals <- totalmass_year_data %>% 
#  filter(unit_name %in% "Cordillera de Merida") %>%
#  group_by(model_nr,scn) %>% 
#  group_split() %>%
#  map(~RSts(.x$year,.x$mean_mass)) %>% 
#  bind_rows()

RSvals <- totalmass_year_data %>% 
  filter(unit_name %in% c("Cordilleras de Colombia",
                          "Sierra Nevada de Santa Marta", 
                          "Cordilleras Norte de Peru" ,
                          "Ecuador")) %>%
#  filter(unit_name %in% c("Ecuador")) %>%
  group_by(unit_name,model_nr,scn) %>% 
  group_modify(~RSts(.x$year,.x$mean_mass,vmin=.x$min_mass,vmax=.x$max_mass)) 

ggplot(RSvals) +
  ## geom error bar is small compared to intermodel variability, keep out of the plot
  #  geom_errorbar(aes(x=year,ymin=RS_min,ymax=RS_max),alpha=.25) +
  geom_point(aes(x=year,y=RS,colour=scn),alpha=.50,cex=.5) +
  facet_grid(scn~unit_name) +
  theme(legend.position = "none")

RSvals%>% filter(year==2100) %>% select(RS,RS_min,RS_max) %>%
  ggplot() +
  geom_histogram(aes(x=RS,fill=scn))


RSvals%>% ungroup %>% filter(year==2100) %>% 
  group_by(unit_name,scn) %>% 
  summarise(RS=median(RS),RS_lower=min(RS_max),RS_upper=max(RS_min)) 

```





```{r}
slc_unit <- "Ecuador"
dat1 <- RS_results %>% 
  filter(unit %in% slc_unit, threshold %in% c("acc","ess")) %>% 
  mutate(year=case_when(
    timeframe %in% "2011-2040"~2025,
    timeframe %in% "2041-2070"~2055,
    timeframe %in% "2071-2100"~2085
    ),
    scn=str_replace(pathway,"[ssp]+([0-9])([0-9])([0-9])","SSP\\1-\\2.\\3"),) %>%
  group_by(scn,threshold,timeframe,year,modelname) %>%
  summarise(n=n(),RSmean=mean(RS_cor),RSmed=median(RS_cor))

dat2 <- totalmass_year_data %>% 
  filter(unit_name %in% c(slc_unit)) %>%
  group_by(unit_name,model_nr,scn) %>% 
  group_modify(~RSts(.x$year,.x$mean_mass)) 

ggplot(dat2) +
  annotate("rect",
           xmin=c(2011,2041,2071),
           ymin=0,
           xmax=c(2040,2070,2100),
           ymax=1,
           fill="pink4",alpha=.15) +
  geom_point(aes(x=year,y=RS),alpha=.50,cex=.5) +
  geom_boxplot(data=dat1,
               aes(y = RSmean, 
                   x = year, 
                   colour=threshold, 
                   group=interaction(threshold,timeframe))) + 
  facet_grid(scn~.) 
```


```{r}
slc_unit <- "Ecuador"
slc_unit <- "Cordilleras Norte de Peru"
dat1 <- RS_results %>% 
  filter(unit %in% str_replace_all(slc_unit," ","-"), threshold %in% c("acc","ess")) %>% 
  mutate(year=case_when(
    timeframe %in% "2011-2040"~2040,
    timeframe %in% "2041-2070"~2070,
    timeframe %in% "2071-2100"~2100
    ),
    scn=str_replace(pathway,"[ssp]+([0-9])([0-9])([0-9])","SSP\\1-\\2.\\3"),) %>%
  group_by(scn,threshold,timeframe,year,modelname) %>%
  summarise(n=n(),RS=mean(RS_cor),RSmed=median(RS_cor)) %>%
  ungroup %>%
  select(scn,threshold,year,RS)

dat2 <- totalmass_year_data %>% 
  filter(year %in% c(2000,2040,2070,2100)) %>% 
  filter(unit_name %in% c(slc_unit)) %>%
  group_by(model_nr,scn) %>% 
  group_modify(~RSts(.x$year,.x$mean_mass)) %>%
  ungroup %>% 
  transmute(scn,threshold="MBM",year,RS)

dats <- dat1 %>% bind_rows(dat2)
ggplot(dats) +
  geom_boxplot(data=dats,
               aes(y = RS, 
                   x = year, 
                   colour=threshold, 
                   group=interaction(threshold,year))) + 
  facet_grid(scn~.) 
```

Very simple model
```{r}

slc_unit <- c("Cordillera de Merida", "Kilimanjaro", "Ruwenzori", "Ecuador", "Cordilleras Norte de Peru")
dat1 <- RS_results %>% 
  filter(unit %in% str_replace_all(slc_unit," ","-"), threshold %in% c("acc","ess")) %>% 
  mutate(year=case_when(
    timeframe %in% "2011-2040"~2040,
    timeframe %in% "2041-2070"~2070,
    timeframe %in% "2071-2100"~2100
    ),
    scn=str_replace(pathway,"[ssp]+([0-9])([0-9])([0-9])","SSP\\1-\\2.\\3"),) %>%
  group_by(unit,scn,threshold,timeframe,year,modelname) %>%
  summarise(n=n(),RS=mean(RS_cor),RSmed=median(RS_cor)) %>%
  ungroup %>%
  transmute(unit_name=str_replace_all(unit,"-"," "),scn,threshold,year,RS)

dat2 <- totalmass_year_data %>% 
  filter(year %in% c(2000,2040,2070,2100)) %>% 
  filter(unit_name %in% slc_unit) %>%
  group_by(unit_name,model_nr,scn) %>% 
  group_modify(~RSts(.x$year,.x$mean_mass)) %>%
  ungroup %>% 
  transmute(unit_name,scn,threshold="MBM",year,RS)


dats <- dat1 %>% 
  bind_rows(dat2) %>% 
  mutate(
  yr=(year-2040)/30, 
  mtd=factor(threshold,levels=c("MBM","acc","ess")))

#mod1 <- lm(RS ~ yr + mtd + scn, data = dats)
#mod2 <- lm(RS ~ yr + mtd * scn, data = dats)

```

a mixed effect model with units and replicates as random effects would make more sense (and binomial family?)

Using a beta family  is probably best given the RS is related to a proportion not a binomial outcome.
suggestion is to use glmmTMB:
- https://stats.stackexchange.com/questions/233366/how-to-fit-a-mixed-model-with-response-variable-between-0-and-1

The problem is that we have values of 1 (collapse), a solution is to:
> However, you can construct this model yourself with a bit more effort, since (unlike in discrete-count models) the three components (y==0, 0<y<1, y==1) are completely disjoint: a) fit a logistic model for "zero vs non-zero", b) fit a logistic model for "non-one vs one", c) fit a Beta model for the non-zero, non-one data. This will be equivalent (but more cumbersome) to fitting a combination zero-one-inflated model. The log-likelihood will be the sum of the three log-likelihoods.

- https://github.com/glmmTMB/glmmTMB/issues/660

```{r}

require(lme4)
mod1 <- lmer(RS ~ yr + mtd + scn + (1|unit_name), data = dats)

require(glmmTMB)
mod1A <- glmmTMB(RS ~ yr + mtd + scn + (1|unit_name), data = subset(dats,RS<1), family=beta_family)
mod1B <- glmmTMB((RS==1) ~ yr + mtd + scn + (1|unit_name), data = dats, family=binomial)

             
```


```{r}
#| label: fig-Ea
#| fig-cap: Estimated ice mass in Megatonnes for all glacier outlines of the Cordillera de Mérida for each shared socioeconomic pathways. 
#| warning: false

# "Kilimanjaro", "Ecuador", "Mexico"


ggplot(data=totalmass_year_data %>% filter(unit_name == "Cordillera de Merida"), aes(x=year,y=mean_mass)) +
  geom_errorbar(aes(ymin=min_mass, ymax=max_mass), width=.2,
                 position=position_dodge(.9),
                alpha=.5,col="gray") +
	 geom_point(aes(colour=scn),cex=.5) +
	 facet_wrap(.~scn) +
  ylab("Projected annual mass of ice [Mt]") +
  xlab("Year") + 
  theme(legend.position = "none")

```

We use these mass projections to estimate the year of collapse (first year when mass reaches zero) for each combination of models and scenarios. The empirical cumulative distribution function of the year of collapse (@fig-Eb) allow us to estimate the proportion of models indicating collapse for each year. 


```{r}
year_of_collapse_data %>% 
  group_by(unit_name,ssp) %>% 
  summarise(
    prob_collapse=mean(collapse_year<2100)*100,
    prob_min=mean(min_collapse_year<2100)*100,
    prob_max=mean(max_collapse_year<2100)*100
    ) %>%
  transmute(
    unit_name,ssp,
    prob_collapse=case_when(
      prob_collapse == prob_max & prob_collapse == prob_min ~ sprintf("%0.1f", prob_collapse),
      TRUE ~ sprintf("%0.1f (%0.1f -- %0.1f)", prob_collapse, prob_max, prob_min)
    )
  ) %>%
  pivot_wider(names_from=ssp,values_from=prob_collapse)
```

For nine units the massbalance models predict total loss of ice between 2040 and 2010

```{r}
#| label: fig-Eb
#| fig-cap: ECDF (empirical cumulative distribution function) plot of year of collapse for all models (black line) and for each shared socioeconomic pathways (SSP, labeled lines).
#| warning: false


ggplot(data=year_of_collapse_data %>% filter(collapse_year < 2100)) +
  geom_histogram(aes(x=collapse_year,fill=ssp)) +
  xlab("Year of collapse") + 
  facet_wrap(~unit_name) +
  theme(legend.position = "top")

```


```{r}
#| label: fig-Eb
#| fig-cap: ECDF (empirical cumulative distribution function) plot of year of collapse for all models (black line) and for each shared socioeconomic pathways (SSP, labeled lines).
#| warning: false


label_xy <- 
  year_of_collapse_data %>% 
  filter(unit_name=="Mexico") %>%
    group_by(ssp) %>% 
  summarise(x=median(collapse_year)) %>%
  mutate(y=0.5)

ggplot(data=year_of_collapse_data %>% 
  filter(unit_name=="Mexico") ) +
#  geom_histogram(aes(x=collapse_year,fill=scn)) +
  stat_ecdf(aes(x=collapse_year,color = ssp,linetype = ssp), 
              geom = "step") +
  stat_ecdf(aes(x=collapse_year), 
              geom = "step",lwd=1.3) +
    geom_label_repel(
    aes(x=x,y=y,label = ssp, color=ssp), data = label_xy,
    size = 3) +
  xlab("Year of collapse") + 
  theme(legend.position = "none")

```
Focusing on the 50 year time frame between 2020 and 2070 we find that `r sprintf("%0.1f %%", ecdf(plot_data$collapse_year)(2070)*100)` of the models end in collapse. Uncertainty in mass estimates (mean absolute deviation) do not have a major effect on the estimated year of collapse. Considering each scenarios separately, the proportion of models that predict collapse by 2070 is higher than 50% (threshold for CR) in all cases, except for scenario SSP1-2.6.

Criterion E is evaluated as **Critically Endangered**.



---
title: "Visualisation of Relative Severity values"
output: html_document
editor_options: 
  chunk_output_type: console
---


We use the tropical glacier ecosystems as a model because:

- risk of ecosystem collapse is very high and well documented
- actual probabilities of collapse can be calculated from mechanistic models,
- the different assessment units differ in extent: from the isolated glaciers in .... to the highly connected of the sierra blanca in Peru.

We use projected degradation of climatic suitability because:

- it is conceptually linked to models used to calculate probability of collapse
- it uses the same underlying variables models and scenarios
- we can explore different time frames (temporal scale of degradation)
- we can explore uncertainty due to different models, scenarios and collapse thresholds

The values of relative severity vary across the sample of sites. Degradation is considered a threat to the ecosystem if it is widespread and/or severe in its intensity. Thus moderate values of relative severity across a large extent or high values of relative severity in a moderate extent of the ecosystem distribution could produce similar level of threat.


```{r}
#| eval: true
#| echo: false
#| message: false
library(dplyr)
library(ggplot2)
library(readr)
library(ggforce)
library(DT)
here::i_am("docs/viz-RS-per-unit.qmd")
# sessionInfo()

```

```{r}
#| eval: true
#| message: false
target.dir <- "sandbox"
RS_results <- read_csv(here::here(target.dir,"relative-severity-degradation-suitability-all-tropical-glaciers.csv"))
source(here::here("inc","R","RS-functions.R"))
```

```{r}

old <- theme_set(theme_linedraw())
theme_update(panel.grid.minor = element_line(colour = "pink"),
panel.grid.major = element_line(colour = "rosybrown3"))

```

## Rwenzori

with this one, boxplots are more informative, small number of cells, could actually plot all pathways/models and timefrmaes, to show consistent results?

```{r}
RS_results %>% 
  filter(unit %in% "Rwenzori") %>% 
  group_by(timeframe, modelname, pathway, threshold) %>% 
  summarise(
    n=n(),
    mean_RS=mean(RS,na.rm=T),
    mean_RS_cor=mean(RS_cor,na.rm=T)) %>% 
  DT::datatable()

```

```{r}
ggplot(RS_results %>% 
  filter(unit %in% "Rwenzori") ) +
  geom_boxplot(aes(y = RS_cor, x = timeframe, colour = threshold)) +
  facet_grid(~pathway) 
```

## Ecuador

This looks nice in the histogram, right skewed

```{r}
ggplot(RS_results %>% filter(threshold=="acc", unit=="Ecuador")) +
  geom_histogram(aes(x=RS_cor,fill=IUCN_cat)) +
  xlab("Relative severity") +
  ylab("Count") +
  facet_col(~timeframe) +
  scale_fill_manual(values = IUCN_cat_colours) +
  theme(legend.position = "none") +
  labs(title="Ecuador", subtitle="Accuracy threshold")
```

```{r}
ggplot(RS_results %>% filter(threshold=="acc", unit=="Ecuador")) +
  geom_histogram(aes(x=RS_cor,fill=IUCN_cat)) +
  xlab("Relative severity") +
  ylab("Count") +
  facet_col(~timeframe) +
  scale_fill_manual(values = IUCN_cat_colours) +
  theme(legend.position = "none") +
  labs(title="Ecuador", subtitle="Accuracy threshold")
```


## Cordilleras-Norte-de-Peru

this is probably an error? not including all clusters?

```{r}
tt <- RS_results %>% 
  filter(unit == "Cordilleras-Norte-de-Peru",
    timeframe == "2041-2070",
    threshold == "acc") %>% 
  pull(IUCN_cat) %>% table

tt

tt/sum(tt)

# RS_results %>% filter(timeframe=="2041-2070",threshold=="acc") %>% arrange(desc(RS_cor)) %>% select(RS,RS_cor)

```

## Cordilleras-Orientales-de-Peru-y-Bolivia
this is the less threatened, shows a transition from VU for short time frames to EN in longer timeframes, histogram almost bimodal.

```{r}


RSecdf <- tibble()
for (tfm in c("2011-2040", "2041-2070", "2071-2100")) {
  for (thr in c("acc")) {
    RSvals <- RS_results %>% 
      filter(
        unit == "Cordilleras-Orientales-de-Peru-y-Bolivia",
        timeframe==tfm,
        threshold==thr) %>% 
      pull(RS_cor)
    RSecdf <- RSecdf %>% 
      bind_rows(
        {RSvExt(RSvals) %>% mutate(timeframe = tfm, threshold = thr)}
      )
  }
}



RScats <- tibble(
  RS_min=c(80,50,30,80,50,80),
  RS_max=c(100,80,50,100,80,100),
  extent_min=c(80,80,80,50,50,30),
  extent_max=c(100,100,100,80,80,50),
  category=c("CR","EN","VU","EN","VU","VU"))


ggplot(RSecdf) +
  geom_rect(data=RScats, 
            aes(fill = category, 
                ymin = RS_min, ymax = RS_max,
                xmin = extent_min, xmax = extent_max),
            alpha=1) +
  geom_line(aes(x=Extent,y=RS,lty=timeframe)) +
  scale_fill_manual(values = IUCN_cat_colours) +
  labs(title="Cordilleras orientales de Peru y Bolivia", 
    subtitle="Maximum accuracy threshold") +
    xlab("Cummulative extent") +
    ylab("Relative severity")
```



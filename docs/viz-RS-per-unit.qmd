---
title: "Visualisation of Relative Severity values"
output: html_document
editor_options: 
  chunk_output_type: console
---


We use the tropical glacier ecosystems as a model because:

- risk of ecosystem collapse is very high and well documented
- actual probabilities of collapse can be calculated from mechanistic models,
- the different assessment units differ in extent: from the isolated glaciers in .... to the highly connected of the sierra blanca in Peru.

We use projected degradation of climatic suitability because:

- it is conceptually linked to models used to calculate probability of collapse
- it uses the same underlying variables models and scenarios
- we can explore different time frames (temporal scale of degradation)
- we can explore uncertainty due to different models, scenarios and collapse thresholds

The values of relative severity vary across the sample of sites. Degradation is considered a threat to the ecosystem if it is widespread and/or severe in its intensity. Thus moderate values of relative severity across a large extent or high values of relative severity in a moderate extent of the ecosystem distribution could produce similar level of threat.


```{r}
#| eval: true
#| echo: false
#| message: false
library(dplyr)
library(ggplot2)
library(readr)
library(ggforce)
library(DT)
library(purrr)
library(ggpubr)
here::i_am("docs/viz-RS-per-unit.qmd")
# sessionInfo()

```

```{r}
#| eval: true
#| message: false
target.dir <- "sandbox"
results_file <- here::here(target.dir, "relative-severity-degradation-suitability-all-tropical-glaciers.csv")
RS_results <- read_csv(results_file, show_col_types = FALSE)
source(here::here("inc","R","RS-functions.R"))
```

```{r}

old <- theme_set(theme_linedraw())
theme_update(panel.grid.minor = element_line(colour = "pink"),
panel.grid.major = element_line(colour = "rosybrown3"))

```

## Rwenzori

For small assessment units the number of calculated RS values is small and differences can be visualised conveniently with a boxplot.

```{r}
RS_results %>% 
  filter(unit %in% "Rwenzori") %>% 
  group_by(timeframe, modelname, pathway, threshold) %>% 
  summarise(
    n=n(),
    mean_RS=mean(RS,na.rm=T),
    mean_RS_cor=mean(RS_cor,na.rm=T)) %>% 
  DT::datatable()

```

```{r}
#| label: fig-ruwenzori
#| fig-cap: Boxplot of the $RS_{cor}$ values for the Tropical Glacier Ecosystem of Ruwenzori. 
ggplot(RS_results %>% 
  filter(unit %in% "Rwenzori") ) +
  geom_boxplot(aes(y = RS_cor, colour = timeframe)) +
  facet_grid(~threshold) 
```

## Ecuador

In the case of Ecuador we have more than 1500 cells with values of relative severity. We see from the mean RS values that there is an expected increase from 0.487 (VU) to 0.746 (EN).

```{r}
RS_results %>% 
  filter(
    threshold=="acc",
    unit %in% "Ecuador",
    modelname == "mri-esm2-0"
         ) %>% 
  group_by(timeframe, pathway) %>% 
  summarise(
    n=n(),
    mean_RS=mean(RS,na.rm=T),
    mean_RS_cor=mean(RS_cor,na.rm=T)) %>% 
  DT::datatable()

```

Histograms of the relative severity values show a wide spread in the nearest future timeframe, with most cell in the 50 - 80 % interval, but many cells in the lowest intervals. The shape of the histogram changes in the following prediction time frames, and there is a large number of cells in the 80 - 100 % interval.


```{r}
#| label: fig-hist-ecuador
#| fig-cap: Histogram of the $RS_{cor}$ values for the Tropical Glacier Ecosystem of Ecuador using the maximum accuracy threshold.
plot_a <- 
  ggplot(RS_results %>% filter(threshold=="acc", unit=="Ecuador")) +
    geom_histogram(aes(x=RS_cor*100,fill=IUCN_cat)) +
    facet_col(~timeframe) +
    scale_fill_brewer(palette = "Oranges",type="seq", direction=-1) +
#    scale_fill_manual(values = IUCN_cat_colours) +
    theme(legend.position = "none") +
    xlab("Relative severity") +
    ylab("Nr. of cells") 
plot_a 
```

Although there is now a large number of cell with very high values of relative severity, this still does not represent a majority of the extent of the ecosystem. We can use an alternative visualisation to make this more explicit. We first flip the coordinates of the histogram and then count the cummulative number of cells starting with the highest relative severity values.

```{r}
#| label: fig-hist-ecdf-ecuador
#| fig-cap: Comparing the histogram of the $RS_{cor}$ values with a modified empirical cumulative distriution function for the Tropical Glacier Ecosystem of Ecuador using the maximum accuracy threshold.
tfm <- RS_results %>% distinct(timeframe) %>% pull

RS_ecdf_f <- RS_results %>% filter(threshold=="acc", unit=="Ecuador") %>% 
  split(.$timeframe) %>%   # splits the dataset by timeframe 
  map(~RS_ecdf(.x$RS_cor))

RS_ext_pts <- 
  bind_rows(
    {tibble(rss = c(80,50,30),timeframe="2011-2040") %>%
      mutate(exts=RS_ecdf_f[[1]](100-rss)*100)},
    {tibble(rss = c(80,50,30),timeframe="2041-2070") %>%
      mutate(exts=RS_ecdf_f[[2]](100-rss)*100)},
    {tibble(rss = c(80,50,30),timeframe="2071-2100") %>%
      mutate(exts=RS_ecdf_f[[3]](100-rss)*100)},
    )


RS_ecdf_ext <- RS_results %>% filter(threshold=="acc", unit=="Ecuador") %>% 
  split(.$timeframe) %>%   # splits the dataset by timeframe 
  map(~RSvExt(.x$RS_cor)) %>%
  bind_rows  %>%
  mutate(timeframe=rep(tfm,c(100,100,100)))

plot_b <- 
  ggplot(RS_ecdf_ext) +
    geom_line(aes(x=Extent,y=RS)) +
    facet_col(~timeframe) +
    scale_fill_manual(values = IUCN_cat_colours) +
    xlab("Cummulative extent") +
    ylab("Relative severity") 


ggarrange(plot_a + coord_flip(), 
          plot_b +  
            geom_hline(yintercept = c(30,50,80), col = "maroon", lty=3) +
            geom_point(data=RS_ext_pts, aes(x=exts,y=rss), col = "maroon") +
            geom_label(data=RS_ext_pts, 
                      aes(x=exts, y=rss, 
                          label=sprintf("%0.1f %%",exts)),
                      col = "maroon",
                      cex=3)) 

```

This arrangement allows to read the cummulative extent by different thresholds of relative severity. For example, there ecosystem extent with $RS ≥ 80%$ increases from less than 2% in the first timeframe to 37.2 and 29.1 %, and the extent with $RS ≥ 30%$ increases from just below 80% to more than 96%. 

We can actually visualise the relationship between this curve and the IUCN category threshold in a convenient way:


```{r}
#| label: fig-ecdf-ecuador
#| fig-cap: Comparison of the modified empirical cumulative distribution function of the $RS_{cor}$ values for the Tropical Glacier Ecosystem of Ecuador with the thresholds for IUCN categories of threat. 
plot_b +
  geom_rect(data=RS_extent_combs, 
            aes(fill = category, 
                ymin = RS_min, ymax = RS_max,
                xmin = extent_min, xmax = extent_max),
            alpha=0.44)

```

We see that the top curve overlaps with the threshold for the category VU, and the two lower curves overlap both VU and EN.

## Cordilleras-Norte-de-Peru

this is probably an error? not including all clusters?

```{r}
tt <- RS_results %>% 
  filter(unit == "Cordilleras-Norte-de-Peru",
    timeframe == "2041-2070",
    threshold == "acc") %>% 
  pull(IUCN_cat) %>% table

tt

tt/sum(tt)

# RS_results %>% filter(timeframe=="2041-2070",threshold=="acc") %>% arrange(desc(RS_cor)) %>% select(RS,RS_cor)

```

## Cordilleras-Orientales-de-Peru-y-Bolivia
this is the less threatened, shows a transition from VU for short time frames to EN in longer timeframes, histogram almost bimodal.

```{r}


RSecdf <- tibble()
for (tfm in c("2011-2040", "2041-2070", "2071-2100")) {
  for (thr in c("acc")) {
    RSvals <- RS_results %>% 
      filter(
        unit == "Cordilleras-Orientales-de-Peru-y-Bolivia",
        timeframe==tfm,
        threshold==thr) %>% 
      pull(RS_cor)
    RSecdf <- RSecdf %>% 
      bind_rows(
        {RSvExt(RSvals) %>% mutate(timeframe = tfm, threshold = thr)}
      )
  }
}




ggplot(RSecdf) +
  geom_rect(data=RS_extent_combs, 
            aes(fill = category, 
                ymin = RS_min, ymax = RS_max,
                xmin = extent_min, xmax = extent_max),
            alpha=1) +
  geom_line(aes(x=Extent,y=RS,lty=timeframe)) +
  scale_fill_manual(values = IUCN_cat_colours) +
  labs(title="Cordilleras orientales de Peru y Bolivia", 
    subtitle="Maximum accuracy threshold") +
    xlab("Cummulative extent") +
    ylab("Relative severity")
```



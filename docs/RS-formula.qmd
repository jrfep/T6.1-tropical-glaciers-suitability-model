---
title: "The Relative Severity formula"
output: html_document
editor_options: 
  chunk_output_type: console
---
## Original RS formula

The original Relative Severity formula is given by:

$$
\mathrm{RS} =
    \frac{\mathrm{OD}}{\mathrm{MD}} =
    \frac{V_{0} - V_{F}}{V_{0} - V_{C}}
$$
Where $V_{0}$ is the initial value of the indicator, $V_{F}$ is the final value, and $V_{C}$ is the collapse threshold. 


```{r}
#| eval: true
#| echo: false
#| message: false
library(dplyr)
library(ggplot2)
library(readr)
library(ggforce)
library(DT)
library(purrr)
library(ggpubr)
library(plotly)
here::i_am("docs/RS-formula.qmd")
# sessionInfo()
# Suppress summarise info
options(dplyr.summarise.inform = FALSE)
```

```{r}
#| eval: true
#| message: false
target.dir <- "sandbox"
results_file <- here::here(target.dir, "relative-severity-degradation-suitability-all-tropical-glaciers.rds")
RS_results <- readRDS(results_file)
results_file <- here::here(target.dir, "massbalance-model-data-all-groups.rds")
massbalance_results <- readRDS(results_file)

source(here::here("inc","R","RS-functions.R"))
```

```{r}

old <- theme_set(theme_linedraw())
theme_update(panel.grid.minor = element_line(colour = "pink"),
panel.grid.major = element_line(colour = "rosybrown3"))

```

### Visualisation of initial and final values

We can use a simple plot of initial ($V_{0}$) vs. final values ($V_{F}$) to visualise the different situations that arise when measure change in time in terms of the values of RS (@fig-interpretation). For risk assessment we are mostly interested in what happens in the lower right half of the plot, i.e. degradation and collapse during the period of observation. Fringe results (small improvements or initial values below the collapse threshold) should not influence the main outcomes of the assessment. However in practice, the application of the original RS formula can produce very unexpected and uninformative results, especially in the left side of the plot, where the initial values are below the collapse threshold.



```{r}
#| label: fig-interpretation
#| fig-cap: Plot of initial ($V_{0}$) vs. final values ($V_{F}$) to visualise the different situations that arise when measure change in time in terms of the values of $\mathrm{RS}$
#| 
artificial_data <- data.frame(iv=seq(0,1,length=25),fv=seq(0,1,length=25))
label_data <- tibble(x=c(0.75,0.45,0.05,0.5,0.05,0.85),
       y=c(0.45,0.65,0.35,0.05,0.05,0.85),
       type=c("Degradation occurring\n 0 < RS < 1",
              "Improvement\nRS < 0",
              "Collapsed\nto\nrecovered?\n RS = ?",
              "Collapsed\nRS > 1",
              "Already\ncollapsed\n RS > 1 ?",
              "No change\nRS=0"))
ggplot(artificial_data) +
  xlab("Initial values") +
  ylab("Final values") +
  geom_line(aes(x=iv,y=fv),lty=2) +
  geom_hline(yintercept = 0.15,lty=3, colour="maroon") +
  geom_vline(xintercept = 0.15,lty=3, colour="maroon") +
  geom_label(data=label_data,aes(x=x,y=y,label=type),alpha=.85) +
  annotate("text",x=0.8,y=0.12,label="collapse threshold",colour="maroon",size=3.4) +
  annotate("text",x=0.12,y=0.8,label="collapse threshold",colour="maroon",size=3.4, angle=90) +
  theme_classic2()

```

### Problems

There are several inconveniences with this formulation:

- if $V_{F}>V_{0}$ the value of $\mathrm{OD}$ is negative and $\mathrm{RS}$ is negative, but the magnitude can change dramatically with different values of $\mathrm{MD}$,
- if $V_{C}>V_{0}$ the value of $\mathrm{MD}$ is negative and $\mathrm{RS}$ is also negative,
- if both $V_{C}>V_{0}$ and $V_{F}>V_{0}$ the value of  $\mathrm{OD}$ and $\mathrm{MD}$ are negative and $\mathrm{RS}$ is positive,
- if $|\mathrm{OD}| > |\mathrm{MD}|$ the value of $\mathrm{RS}$ increases disproportionatly.

This means that negative values of RS can have completely different meanings.

## Conditional formula for RS

We propose to use a conditional formula to avoid artifacts:

$$
\mathrm{RS}_{cor}=
    \begin{cases}
      0, & \text{if}\ V_{0} ≤ V_{F} \text{ and}\ V_{F} > V_{C}\\
      \mathrm{OD}/\mathrm{MD}, & \text{otherwise} \\
      1, & \text{if}\ V_{F} ≤ V_{C} \\
    \end{cases}
$$

This formula focuses on measuring degradation, and we suggest the use of alternative measures or indices for other purposes. Although values of $RS<0$ could be informative for indicating recovery or improvement, we argue that their magnitude would not be informative for decision making purposes and could be confusing. 


## Examples

We illustrate the differences between both formulas with some examples.

### Ruwenzori

We focus initially in the case of the Tropical Glacier Ecosystems of the Ruwenzori mountains in Africa. This is a small region and we have calculated bioclimatic suitability for 11 raster cells overlaping with glacier outlines.

We use the predictions of the bioclimatic suitability model for current conditions as the initial values ($V_0$). We then calculate a threshold of equal sensitivity and specificity based on the confusion matrix of the testing subsample of occurrences and use this as a colapse threshold ($V_{C}=0.169$). We then predict the suitability values for future climatic conditions based on one combination of global circulation model and scenario (mri-esm2-0, ssp126) for the period 2041-2070. Values are shown in table [@tbl-ruwenzori].


```{r}
#| label: tbl-ruwenzori
#| tbl-cap: "Calculation of RS using the original and the conditional formula for the T.G.E. of Ruwenzori."
#| tbl-subcap: "The calculation is based on predicted future bioclimatic suitability from one global circulation model (mri-esm2-0) for the period 2041-2070 and using an equal sensitivity and specificity threshold."

d <- RS_results %>% 
  filter(
    unit %in% "Ruwenzori",
    pathway %in% "ssp126",
    modelname %in% "mri-esm2-0",
    timeframe %in% "2041-2070",
    threshold %in% "ess"
    )
 d  %>% 
  transmute(IV, FV, OD, MD, RS, RS_cor) %>%
  datatable(
    options = list(
      dom = 't', 
      pageLength = -1,
      order = list(list(5, 'asc'))),
    colnames = c("V_{0}", "V_{F}", "OD", "MD", "RS", "RS_{cor}")
    ) %>% formatRound(c("IV", "FV", "OD", "MD", "RS", "RS_cor"),digits=3)  
```


For one cell the initial value is below the collapse threshold and thus the value of $MD$ and $RS$ are negative. For other  four cells the value of $V_{F}$ is below $V_{C}$ and we get values of $RS>1$ with two extreme cases where the $V_{F}$ is virtually the same, but the corresponding $V_{C}$ values are so close to the collapse threshold that $OD$ is multiple times larger than $MD$. With the conditional formula, all these extreme cases would be considered $RS=1$, i.e. collapsed. We can visualise these data points in an interactive plot (@fig-ruwenzori).

```{r}
#| label: fig-ruwenzori
#| fig-cap: "Plot of initial ($V_{0}$) vs. final values ($V_{F}$) for the T.G.E. of Ruwenzori."
#| warning: false
d <- d %>%
  mutate(cat = case_when(
    IV == CV ~"Collapsed<br>(MD == 0)",
    IV < CV ~"Collapsed<br>(IV < CV)",
    FV < CV ~"Collapsed<br>(FV < CV)",
    OD > MD ~ "Collapsed<br>(OD > MD)",
    OD < 0 ~ "Improved\n(OD < 0)",
    TRUE ~ "Degradation\n(0 < RS < 1)"
  ))

colline.fmt = list(dash="dash", width = 0.5, color='red')
ncline.fmt = list(dash="dot", width = 0.5, color='brown')

fig <- plot_ly(
  d, x = ~IV, y = ~FV,
  # Hover text:
  text = ~sprintf("Obs. decline: %0.3f<br>Max. decline: %0.3f<br>Rel. severity: %0.3f<br>Rel. sev. (cond): %0.3f<br>%s", 
                  OD, MD,RS,RS_cor,cat)
)
fig <- add_markers(fig, color = ~cat, size = ~RS_cor,
            symbol = ~cat, symbols = c('o','x','circle')) 
fig <- add_lines(fig, x = ~IV, y = ~IV, name="no change", line=ncline.fmt)
fig <- add_lines(fig, y = unique(d$CV), name="collapse threshold", line=colline.fmt)
fig <- add_lines(fig, x = unique(d$CV), name="collapse threshold", line=colline.fmt)


layout(fig,
       #title = "Example Relative Severity calculation  (Rwenzori)",
       xaxis = list(title="Initial value"),
       yaxis = list(title="Final value")
       )
```


In this unit, the positive predictive rate threshold if very high (0.698) and we have the problem that most of the initial values are above the threshold and the formula of RS give uninformative results. Using the conditional formula, all these cased would be calculated as $RS=1$ or collapsed.


```{r}
#| label: tbl-planets
#| tbl-cap: Planets
RS_results %>% 
  filter(
    unit %in% "Ruwenzori",
    pathway %in% "ssp126",
    modelname %in% "mri-esm2-0",
    timeframe %in% "2041-2070",
    threshold %in% "ppv",
    )  %>% 
  select(id,cellnr,CV,IV,FV,OD,MD,RS,RS_cor) %>%
  DT::datatable()

```

Aggregating the original RS values can be problematic. In this table we can compare the mean values for different thresholds and time frames. Using the conditional RS formula we see a clear increasing trend, but the values of the original formula translate to unpredictable and uninformative mean values of RS.

```{r}
RS_results %>% 
  filter(
    unit %in% "Ruwenzori",
    threshold %in% "ess",
    modelname %in% "mri-esm2-0"
    ) %>% 
  group_by( pathway, timeframe) %>% 
  summarise(
    n=n(),
    mean_RS=mean(RS,na.rm=T),
    mean_RS_cor=mean(RS_cor,na.rm=T)) %>% 
  DT::datatable()

```

### Ecuador

Let's consider now the case of the tropical glacier ecosystem of Ecuador. Here we have a larger sample due to the larger extent and number of glaciers. We focus here in the nearest time frame and see that some cells have larger final values than the initial values. With the conditional formula these units will be considered $RS=0$ and this means that the magnitude of the improvement is lost. The consequence of this interpretation for the risk assessment needs to be discussed in more detail, but it is unlikely to be of much consequence in this case study where the trend is overwhelmingly negative. For studied focused on ecosystem recovery, a negative value of $OD$ might be informative, but its relationship with the $MD$ could be explored in alternative ways.

```{r}

d <- RS_results %>% 
  filter(
    unit %in% "Ecuador",
    timeframe %in% "2011-2040",
    pathway %in% "ssp126",
    modelname %in% "mri-esm2-0",
    threshold %in% "ess"
    ) %>%
  mutate(cat = case_when(
    IV == CV ~"Collapsed<br>(MD == 0)",
    IV < CV ~"Collapsed<br>(IV>CV)",
    FV < CV ~"Collapsed<br>(FV>CV)",
    OD > MD ~ "Collapsed<br>(OD > MD)",
    OD < 0 ~ "Improved\n(OD < 0)",
    TRUE ~ "Degradation\n(0 < RS < 1)"
  ))


colline.fmt = list(dash="dash", width = 0.5, color='red')
ncline.fmt = list(dash="dot", width = 0.5, color='brown')

fig <- plot_ly(
  d, x = ~IV, y = ~FV,
  # Hover text:
  text = ~sprintf("Obs. decline: %0.3f<br>Max. decline: %0.3f<br>Rel. severity: %0.3f<br>Rel. sev. (cond): %0.3f<br>%s", 
                  OD, MD,RS,RS_cor,cat)
)
fig <- add_markers(fig, color = ~cat, size = ~RS_cor,
            symbol = ~cat, symbols = c('o','x','circle','+')) 
fig <- add_lines(fig, x = ~IV, y = ~IV, name="no change", line=ncline.fmt)
fig <- add_lines(fig, y = unique(d$CV), name="collapse threshold", line=colline.fmt)
fig <- add_lines(fig, x = unique(d$CV), name="collapse threshold", line=colline.fmt)


layout(fig,
       title = "Example Relative Severity calculation (Ecuador)",
       xaxis = list(title="Initial value"),
       yaxis = list(title="Final value")
       )
```

## Kilimanjaro

Problems with the time series of ice mass balance in Kilimanjaro, where there is a predicted increase in ice mass at the start of the time series

```{r}

RSvals <- massbalance_results %>% 
  filter(
    unit_name %in% c("Kilimanjaro"),
    model_nr %in% c(" 3"," 6"," 9"),
  ) %>%
#  filter(unit_name %in% c("Ecuador")) %>%
  mutate(min_mass=mass-mad,max_mass=mass+mad) %>% 
  group_by(RGIId,model_nr,scn) %>% 
  group_modify(~RSts(.x$year,.x$mass,vmin=.x$min_mass,vmax=.x$max_mass)) 

ggplot(RSvals) +
  ## geom error bar is small compared to intermodel variability, keep out of the plot
    geom_errorbar(aes(x=year,ymin=RS_min,ymax=RS_max),alpha=.25) +
  geom_point(aes(x=year,y=RS,colour=scn),alpha=.50,cex=.5) +
  facet_grid(scn~model_nr) +
  theme(legend.position = "none")

```
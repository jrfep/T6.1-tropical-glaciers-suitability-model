---
title: "The Relative Severity formula"
output: html_document
editor_options: 
  chunk_output_type: console
---
## Original RS formula

The original Relative Severity formula is given by:

$$
\mathrm{RS} =
    \frac{\mathrm{OD}}{\mathrm{MD}} =
    \frac{V_{0} - V_{F}}{V_{0} - V_{C}}
$$
Where $V_{0}$ is the initial value of the indicator, $V_{F}$ is the final value, and $V_{C}$ is the collapse threshold. 


```{r}
#| eval: true
#| echo: false
#| message: false
library(dplyr)
library(ggplot2)
library(readr)
library(ggforce)
library(DT)
library(purrr)
library(ggpubr)
library(plotly)
here::i_am("docs/viz-RS-per-unit.qmd")
# sessionInfo()

```

```{r}
#| eval: true
#| message: false
target.dir <- "sandbox"
results_file <- here::here(target.dir, "relative-severity-degradation-suitability-all-tropical-glaciers.rds")
RS_results <- readRDS(results_file)
source(here::here("inc","R","RS-functions.R"))
```

```{r}

old <- theme_set(theme_linedraw())
theme_update(panel.grid.minor = element_line(colour = "pink"),
panel.grid.major = element_line(colour = "rosybrown3"))

```

### Visualisation of initial and final values

We can use a simple plot of initial ($V_{0}$) vs. final values ($V_{F}$) to visualise the different situations that arise when measure change in time in terms of the values of RS (@fig-interpretation). For risk assessment we are mostly interested in what happens in the lower right half of the plot, i.e. degradation and collapse during the period of observation. Fringe results (small improvements or initial values below the collapse threshold) should not influence the main outcomes of the assessment. However in practice, the application of the original RS formula can produce very unexpected and uninformative results, especially in the left side of the plot, where the initial values are below the collapse threshold.



```{r}
#| label: fig-interpretation
#| fig-cap: Plot of initial ($V_{0}$) vs. final values ($V_{F}$) to visualise the different situations that arise when measure change in time in terms of the values of $\mathrm{RS}$.
artificial_data <- data.frame(iv=seq(0,1,length=25),fv=seq(0,1,length=25))
label_data <- tibble(x=c(0.75,0.45,0.05,0.5,0.05,0.85),
       y=c(0.45,0.65,0.35,0.05,0.05,0.85),
       type=c("Degradation occurring\n 0 < RS < 1",
              "Improvement\nRS < 0",
              "Collapsed\nto\nrecovered?\n RS = ?",
              "Collapsed\nRS > 1",
              "Already\ncollapsed\n RS > 1 ?",
              "No change\nRS=0"))
ggplot(artificial_data) +
  xlab("Initial values") +
  ylab("Final values") +
  geom_line(aes(x=iv,y=fv),lty=2) +
  geom_hline(yintercept = 0.15,lty=3, colour="maroon") +
  geom_vline(xintercept = 0.15,lty=3, colour="maroon") +
  geom_label(data=label_data,aes(x=x,y=y,label=type),alpha=.85) +
  annotate("text",x=0.8,y=0.12,label="collapse threshold",colour="maroon",size=3.4) +
  annotate("text",x=0.12,y=0.8,label="collapse threshold",colour="maroon",size=3.4, angle=90) +
  theme_classic2()

```

### Problems

There are several inconveniences with this formulation:

- if $V_{F}>V_{0}$ the value of $\mathrm{OD}$ is negative and $\mathrm{RS}$ is negative, but the magnitude can change dramatically with different values of $\mathrm{MD}$,
- if $V_{C}>V_{0}$ the value of $\mathrm{MD}$ is negative and $\mathrm{RS}$ is also negative,
- if both $V_{C}>V_{0}$ and $V_{F}>V_{0}$ the value of  $\mathrm{OD}$ and $\mathrm{MD}$ are negative and $\mathrm{RS}$ is positive,
- if $|\mathrm{OD}| > |\mathrm{MD}|$ the value of $\mathrm{RS}$ increases disproportionatly.

This means that negative values of RS can have completely different meanings.

## Conditional formula for RS

We propose to use a conditional formula to avoid artifacts:

$$
\mathrm{RS}_{cor}=
    \begin{cases}
      0, & \text{if}\ V_{0} ≤ V_{F} \\
      \mathrm{OD}/\mathrm{MD}, & \text{otherwise} \\
      1, & \text{if}\ V_{0} ≤ V_{C} \\
    \end{cases}
$$

This formula focuses on measuring degradation, and we suggest the use of alternative measures or indices for other purposes. Although values of $RS<0$ could be informative for indicating recovery or improvement, we argue that their magnitude would not be informative for decision making purposes and could be confusing. 


## Examples

We illustrate the differences between both formulas with some illustrative examples.

### Ruwenzori

We focus initially in the case of the tropical glacier ecosystems of Rwenzori mountains in Africa. 

When we consider future projections from one model and scenario (mri-esm2-0, ssp126) for the timeframe 2041-2070, and use a collapse threshold of 0.056 (equal sensitivity and specificity threshold), we find that for one cells the initial value is equal to the collapse threshold, thus maximum decline is zero and the RS formula is undefined. For another cell the final value is much lower than the collapse threshold and the observed decline is more than twice as large as the maximum decline. With the conditional formula, these extreme cases would be considered $RS=1$, i.e. collapsed.


```{r}
RS_results %>% 
  filter(
    unit %in% "Ruwenzori",
    pathway %in% "ssp126",
    modelname %in% "mri-esm2-0",
    timeframe %in% "2041-2070",
    threshold %in% "ess",
    )  %>% 
  select(id,cellnr,CV,IV,FV,OD,MD,RS,RS_cor) %>%
  DT::datatable()

```

In this interactive plot, we can visualise these problems 
```{r}

d <- RS_results %>% 
  filter(
    unit %in% "Ruwenzori",
    pathway %in% "ssp126",
    modelname %in% "mri-esm2-0",
    timeframe %in% "2041-2070",
    threshold %in% "ess"
    ) %>%
  mutate(cat = case_when(
    IV == CV ~"Collapsed<br>(MD == 0)",
    IV < CV ~"Collapsed<br>(IV < CV)",
    FV < CV ~"Collapsed<br>(FV < CV)",
    OD > MD ~ "Collapsed<br>(OD > MD)",
    OD < 0 ~ "Improved\n(OD < 0)",
    TRUE ~ "Degradation\n(0 < RS < 1)"
  ))


colline.fmt = list(dash="dash", width = 0.5, color='red')
ncline.fmt = list(dash="dot", width = 0.5, color='brown')

fig <- plot_ly(
  d, x = ~IV, y = ~FV,
  # Hover text:
  text = ~sprintf("Obs. decline: %0.3f<br>Max. decline: %0.3f<br>Rel. severity: %0.3f<br>%s", 
                  OD, MD,RS_cor,cat)
)
fig <- add_markers(fig, color = ~cat, size = ~RS_cor,
            symbol = ~cat, symbols = c('o','x','circle')) 
fig <- add_lines(fig, x = ~IV, y = ~IV, name="no change", line=ncline.fmt)
fig <- add_lines(fig, y = unique(d$CV), name="collapse threshold", line=colline.fmt)
fig <- add_lines(fig, x = unique(d$CV), name="collapse threshold", line=colline.fmt)


layout(fig,
       title = "Example Relative Severity calculation  (Rwenzori)",
       xaxis = list(title="Initial value"),
       yaxis = list(title="Final value")
       )
```


In this unit, the positive predictive rate threshold if very high (0.698) and we have the problem that most of the initial values are above the threshold and the formula of RS give uninformative results. Using the conditional formula, all these cased would be calculated as $RS=1$ or collapsed.


```{r}
RS_results %>% 
  filter(
    unit %in% "Ruwenzori",
    pathway %in% "ssp126",
    modelname %in% "mri-esm2-0",
    timeframe %in% "2041-2070",
    threshold %in% "ppv",
    )  %>% 
  select(id,cellnr,CV,IV,FV,OD,MD,RS,RS_cor) %>%
  DT::datatable()

```

Aggregating the original RS values can be problematic. In this table we can compare the mean values for different thresholds and time frames. Using the conditional RS formula we see a clear increasing trend, but the values of the original formula translate to unpredictable and uninformative mean values of RS.

```{r}
RS_results %>% 
  filter(
    unit %in% "Ruwenzori",
    threshold %in% "ess",
    modelname %in% "mri-esm2-0"
    ) %>% 
  group_by( pathway, timeframe) %>% 
  summarise(
    n=n(),
    mean_RS=mean(RS,na.rm=T),
    mean_RS_cor=mean(RS_cor,na.rm=T)) %>% 
  DT::datatable()

```

### Ecuador

Let's consider now the case of the tropical glacier ecosystem of Ecuador. Here we have a larger sample due to the larger extent and number of glaciers. We focus here in the nearest time frame and see that some cells have larger final values than the initial values. With the conditional formula these units will be considered $RS=0$ and this means that the magnitude of the improvement is lost. The consequence of this interpretation for the risk assessment needs to be discussed in more detail, but it is unlikely to be of much consequence in this case study where the trend is overwhelmingly negative. For studied focused on ecosystem recovery, a negative value of $OD$ might be informative, but its relationship with the $MD$ could be explored in alternative ways.

```{r}

d <- RS_results %>% 
  filter(
    unit %in% "Ecuador",
    timeframe %in% "2011-2040",
    pathway %in% "ssp126",
    modelname %in% "mri-esm2-0",
    threshold %in% "ess"
    ) %>%
  mutate(cat = case_when(
    IV == CV ~"Collapsed<br>(MD == 0)",
    IV < CV ~"Collapsed<br>(IV>CV)",
    FV < CV ~"Collapsed<br>(FV>CV)",
    OD > MD ~ "Collapsed<br>(OD > MD)",
    OD < 0 ~ "Improved\n(OD < 0)",
    TRUE ~ "Degradation\n(0 < RS < 1)"
  ))


colline.fmt = list(dash="dash", width = 0.5, color='red')
ncline.fmt = list(dash="dot", width = 0.5, color='brown')

fig <- plot_ly(
  d, x = ~IV, y = ~FV,
  # Hover text:
  text = ~sprintf("Obs. decline: %0.3f<br>Max. decline: %0.3f<br>Rel. severity: %0.3f<br>Rel. sev. (cond): %0.3f<br>%s", 
                  OD, MD,RS,RS_cor,cat)
)
fig <- add_markers(fig, color = ~cat, size = ~RS_cor,
            symbol = ~cat, symbols = c('o','x','circle','+')) 
fig <- add_lines(fig, x = ~IV, y = ~IV, name="no change", line=ncline.fmt)
fig <- add_lines(fig, y = unique(d$CV), name="collapse threshold", line=colline.fmt)
fig <- add_lines(fig, x = unique(d$CV), name="collapse threshold", line=colline.fmt)


layout(fig,
       title = "Example Relative Severity calculation (Ecuador)",
       xaxis = list(title="Initial value"),
       yaxis = list(title="Final value")
       )
```


---
title: "Spatial variability in Relative Severity"
output: html_document
editor_options: 
  chunk_output_type: console
---

So far we have looked at relative severity of the whole assessment unit, either as a total value ($RS_{ice}^{CT=0}$) or a mean value, but the values of relative severity vary across any sample of sites or locations. 

Degradation can be considered a threat to the ecosystem if it is widespread and/or severe in its intensity. Thus moderate values of relative severity across a large extent or high values of relative severity in a moderate extent of the ecosystem distribution could produce similar level of threat.

We will look at the variability of RS among observation units and the relationship between RS and extent of decline for the assessment units.

```{r}
#| eval: true
#| echo: false
#| message: false
library(dplyr)
library(ggplot2)
library(readr)
library(ggforce)
library(DT)
library(purrr)
library(ggpubr)
library(stringr)
here::i_am("docs/RS-spatial-variability.qmd")
# sessionInfo()
# Suppress summarise info
options(dplyr.summarise.inform = FALSE)
```

```{r}
#| eval: true
#| message: false
target.dir <- "sandbox"
results_file <- here::here(target.dir, "relative-severity-degradation-suitability-all-tropical-glaciers.csv")
RS_results <- read_csv(results_file, show_col_types = FALSE) %>% 
  mutate(unit_name=str_replace_all(unit,"-"," "))
results_file <- here::here(target.dir, "massbalance-model-data-all-groups.rds")
massbalance_results <- readRDS(results_file)
source(here::here("inc","R","RS-functions.R"))
```

```{r}

old <- theme_set(theme_linedraw())
theme_update(panel.grid.minor = element_line(colour = "pink"),
panel.grid.major = element_line(colour = "rosybrown3"))

```

## Sample size for each indicator variable

For our two indicator variables we have different sample sizes per assessment unit. In the case of the dynamic ice mass balance model the units of observation are glacier outlines from the Randolph Glacier Inventory, while in the bioclimatic suitability model the units of observation are cell in a spatial grid that overlap with glacier outlines from multiple sources. Differences in sample size are noticeable in three assessment units located in northern Argentina and Chile where national inventories include more detail about different ice accumulations types, including rock glaciers, that are not represented in the global inventories.

```{r}

massbalance_results %>% 
  group_by(unit_name) %>% 
  summarise(`n_{ice}` = n_distinct(RGIId)) %>%
  full_join({
    RS_results %>% 
    group_by(unit_name) %>% 
    summarise(`n(bcs)` = n_distinct(id,cellnr))
    },
    by=c("unit_name")
  ) %>% 
  DT::datatable(options = list(dom = 't', pagination = FALSE, pageLength = -1))

```


## Relative severity per observation unit

### Ice mass

For the indicator variable of ice mass we have used the total ice mass by adding ice mass from different glacier outlines in each assessment unit.

Calculating relative severity for each outline might be misleading because the units differ in initial ice mass and contribute unequaly to the total:

```{r}

mass_su <- massbalance_results %>% 
  filter(
    unit_name %in% c("Kilimanjaro"),
    model_nr %in% c(" 9"),
    scn %in% c("ssp126")
  ) %>%
  mutate(`Aggregation unit`="Glacier outlines", min_mass = mass-mad, max_mass = mass+mad) 
mass_au <- mass_su %>%
  group_by(year) %>%
  summarise(
    `Aggregation unit`="Assessment unit",
    mass=sum(mass),
    min_mass=sum(min_mass),
    max_mass=sum(max_mass)
  ) %>% 
  bind_rows(mass_su)

ggplot(mass_au) +
  ## geom error bar is small compared to intermodel variability, keep out of the plot
  geom_errorbar(aes(x=year,ymin=min_mass,ymax=max_mass),alpha=.25) +
  geom_point(aes(x=year,y=mass, colour=`Aggregation unit`),
    alpha=.50, size=1.5) +
  theme(legend.position = "top")

```

We can clearly see how different glaciers contribute to the total, and that for some periods of time the total amount is influence by several small glaciers, and in other periods it is influence by one large unit contributing most of the mass.

In this case, the calculation of RS for each outline is not informative unless we combine them with a weight related to their initial mass contribution.

```{r}

w <- mass_au %>% filter(year==2000) %>% transmute(`Aggregation unit`,RGIId,initial_mass=mass)

RSvals <- mass_au %>% 
  select(`Aggregation unit`,RGIId,year,mass,min_mass,max_mass) %>% 
  group_by( `Aggregation unit`,RGIId) %>% 
  group_modify( ~ RSts(
    .x$year,
    .x$mass,
    vmin = .x$min_mass,
    vmax = .x$max_mass,
    formula = "conditional"
    )
    ) %>% 
    left_join(w, by = c("Aggregation unit", "RGIId")) 

# A weighted sum would be the same as the RS of the total
RSws <- RSvals %>% 
  filter(`Aggregation unit` %in% "Glacier outlines") %>% 
  transmute(year,RS_weighted=RS*initial_mass/max(w$initial_mass)) %>%
  group_by(year) %>%
  summarise(RS_weighted=sum(RS_weighted))

ggplot(RSvals) +
  geom_errorbar(aes(x = year, ymin = RS_min, ymax = RS_max), alpha = .25) +
  geom_point(aes(x = year, y = RS, colour=`Aggregation unit`, size = initial_mass, alpha = initial_mass)) +
  # geom_point(data=RSws,aes(x=year,y=RS_weighted),col=1)+
  scale_size_continuous(trans="log") +
  theme(legend.position = "right")

```

### Bioclimatic suitability

In the case of the bioclimatic suitability model we are using spatial units with the same area and the index of suitability is not directly related to the amount of ice mass. We have used the the mean of the individual RS values per cell to summarise relative severity per assessment unit. But there are other complementary summary statistics to represent the spatial variability in values of RS in an assessment unit. 

For small assessment units the spatial sample size for the calculation of RS is small and values tend to be relatively similar. Differences can be visualised conveniently with boxplots. The example of the T.G.T. of Ruwenzori shows the divergence between median and mean values of RS, but both show similar trends for each combination of models and scenarios.

```{r}
#| label: fig-ruwenzori
#| fig-cap: "Box and whisker plots of the $RS_{bcs}^{acc}$ values for the Tropical Glacier Ecosystem of Ruwenzori. The middle line represent the location of the median and the box include the distribution from first to third quartile, the location of the mean is marked with an $\times$ symbol."
dat1 <- RS_results %>% 
  filter(unit %in% "Ruwenzori", threshold=="acc")
dat2 <- dat1 %>% 
  group_by(timeframe,pathway,modelname) %>% 
  summarise(mean_RS=mean(RS_cor))

ggplot(dat1 ) +
  geom_boxplot(aes(y = RS_cor, x = timeframe, colour = timeframe)) +
  geom_point(data=dat2, aes(y = mean_RS, x = timeframe, colour = timeframe),pch=4,cex=2) +
  facet_grid(pathway~modelname) +
  theme(legend.position = "top")
```

For larger sampling units we can see more complex distributions of RS values. In the case of Ecuador we have  66 raster cells with values of relative severity. Histograms of the relative severity values show a wide spread in the nearest future timeframe, with most cell in the 50 - 80 % interval, but many cells in the lowest intervals. The shape of the histogram changes in the following prediction time frames, and there is a large number of cells in the 80 - 100 % interval, and these changes are reflected in more marked differences between the mean and median RS values.


```{r}
#| label: fig-hist-ecuador
#| fig-cap: Histogram of the $RS_{cor}$ values for the Tropical Glacier Ecosystem of Ecuador using the maximum accuracy threshold.
#| warning: false
dat1 <- RS_results %>% 
  filter(threshold=="acc", 
         unit=="Ecuador", 
         modelname == "mri-esm2-0",
         pathway == "ssp126")
dat2 <- dat1 %>% group_by(timeframe) %>% 
  summarise(
    n=n(),
    mean_RS=mean(RS_cor,na.rm=T),
    median_RS=median(RS_cor,na.rm=T))

plot_a <- 
  ggplot(dat1) +
    geom_histogram(aes(x=RS_cor*100,fill=IUCN_cat)) +
    facet_grid(timeframe~.) +
    scale_fill_brewer(palette = "Oranges",type="seq", direction=-1) +
    #    scale_fill_manual(values = IUCN_cat_colours) +
    #geom_point(data=dat2,aes(x=mean_RS*100, y=15)) +
    geom_label(data=dat2,aes(x=mean_RS*100, y=15, label=sprintf("mean %0.3f", mean_RS))) +
    geom_label(data=dat2,aes(x=median_RS*100, y=10, label=sprintf("median %0.3f", median_RS))) +
    theme(legend.position = "none") +
    xlab("Relative severity") +
    ylab("Nr. of cells") 
plot_a 
```

Although there is now a large number of cell with very high values of relative severity, this still does not represent a majority of the extent of the ecosystem. We can use an alternative visualisation to make this more explicit:

- we will use here $RS$ expressed in percentage rather than a proportion,
- we will first flip the coordinates of the histogram,
- then count the cummulative number of cells starting with the highest relative severity values,[This is in fact the mirror image of an [empirical cummulative distribution function](https://en.wikipedia.org/wiki/Empirical_distribution_function)]{.aside}
- we express this value as a percentage of the total extent of the assessment unit.

```{r}
#| label: fig-hist-ecdf-ecuador
#| fig-cap: Comparing the histogram of the $RS_{cor}$ values with a modified empirical cumulative distriution function for the Tropical Glacier Ecosystem of Ecuador using the maximum accuracy threshold.
tfm <- dat1 %>% distinct(timeframe) %>% pull

RS_ecdf_f <- dat1 %>% 
  split(.$timeframe) %>%   # splits the dataset by timeframe 
  map(~RS_ecdf(.x$RS_cor))

rss_thr <- c(80,50,30) # IUCN RLE thresholds
rss_thr <- c(75,50,25) # first second and third quartile

RS_ext_pts <- 
  bind_rows(
    {tibble(rss = rss_thr,timeframe="2011-2040") %>%
      mutate(exts=RS_ecdf_f[[1]](100-rss)*100)},
    {tibble(rss = rss_thr,timeframe="2041-2070") %>%
      mutate(exts=RS_ecdf_f[[2]](100-rss)*100)},
    {tibble(rss = rss_thr,timeframe="2071-2100") %>%
      mutate(exts=RS_ecdf_f[[3]](100-rss)*100)},
    )


RS_ecdf_ext <- dat1 %>% 
  split(.$timeframe) %>%   # splits the dataset by timeframe 
  map(~RSvExt(.x$RS_cor)) %>%
  bind_rows  %>%
  mutate(timeframe=rep(tfm,c(100,100,100)))

plot_b <- 
  ggplot(RS_ecdf_ext) +
    geom_line(aes(x=Extent,y=RS)) +
    facet_col(~timeframe) +
    scale_fill_manual(values = IUCN_cat_colours) +
    xlab("Cummulative extent") +
    ylab("Relative severity") 


ggarrange(plot_a + coord_flip(), 
          plot_b +  
            geom_hline(yintercept = rss_thr, col = "maroon", lty=3) +
            geom_point(data=RS_ext_pts, aes(x=exts,y=rss), col = "maroon") +
            geom_label(data=RS_ext_pts, 
                      aes(x=exts, y=rss, 
                          label=sprintf("%0.1f %%",exts)),
                      col = "maroon",
                      cex=3)) 

```

This arrangement allows to read the cummulative extent by different thresholds of relative severity. For example, there ecosystem extent with $RS ≥ 75%$ increases from less than 20% in the first timeframe to 54.5 %, and the extent with $RS ≥ 25%$ increases from just below 80% to almost 85%. 

We can actually superinpose these curves for a quick overview of the increase in extent for each value of relative severity :

```{r}
#| label: fig-ecdf-ecuador
#| fig-cap: Comparison of the modified empirical cumulative distribution function of the $RS_{cor}$ values for the Tropical Glacier Ecosystem of Ecuador with the thresholds for IUCN categories of threat. 

# this does not work in this case, but almost...
# plot_b + facet_null()

ggplot(RS_ecdf_ext) +
    geom_line(aes(x=Extent,y=RS, lty=timeframe)) +
    xlab("Cummulative extent") +
    ylab("Relative severity") 
```

We see that for this combination of model, scenario and threshold, there is an increase in the extent of high severity values between the first and second period, but the distribution does not change much between the second and third period.
